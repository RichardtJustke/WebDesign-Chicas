<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Autenticação - Chicas Eventos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #b95929;
            margin-top: 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .warning { background: #fef3c7; color: #92400e; }
        button {
            background: #b95929;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #a04a1f;
        }
        .test-result {
            font-family: monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🧪 Teste do Sistema de Autenticação Corrigido</h1>
    
    <div class="test-section">
        <h2>👥 Usuários de Teste Disponíveis</h2>
        <div class="test-result">
            <strong>🔧 Credenciais de Teste:</strong><br><br>
            <strong>👤 João Silva (Cliente):</strong><br>
            Email: joao@teste.com<br>
            Senha: 123456<br>
            Telefone: (11) 99999-9999<br><br>
            
            <strong>👩 Maria Santos (Admin):</strong><br>
            Email: maria@teste.com<br>
            Senha: 123456<br>
            Telefone: (11) 88888-8888<br><br>
            
            <strong>👩 Ana Costa (Cliente):</strong><br>
            Email: ana@teste.com<br>
            Senha: 123456<br>
            Telefone: (11) 77777-7777
        </div>
    </div>
    
    <div class="test-section">
        <h2>📊 Status Atual</h2>
        <div id="currentStatus" class="status">Verificando...</div>
        <button onclick="checkStatus()">🔄 Verificar Status</button>
    </div>
    
    <div class="test-section">
        <h2>🔑 Teste de Login</h2>
        <button onclick="testLogin('joao')">👤 Login: João Silva</button>
        <button onclick="testLogin('maria')">👩 Login: Maria Santos</button>
        <button onclick="testLogin('ana')">👩 Login: Ana Costa</button>
        <button onclick="testLogout()">🚪 Fazer Logout</button>
        <div id="loginResult" class="test-result">Nenhum teste executado ainda.</div>
    </div>
    
    <div class="test-section">
        <h2>🔄 Teste de Persistência</h2>
        <button onclick="testPersistence()">⏱️ Testar Persistência de Sessão</button>
        <div id="persistenceResult" class="test-result">Nenhum teste executado ainda.</div>
    </div>
    
    <div class="test-section">
        <h2>👥 Teste de Múltiplos Usuários</h2>
        <button onclick="testMultipleUsers()">🔄 Testar Troca de Usuários</button>
        <div id="multipleUsersResult" class="test-result">Nenhum teste executado ainda.</div>
    </div>
    
    <div class="test-section">
        <h2>👥 Gerenciar Contas</h2>
        <button onclick="goToAccountManager()">👥 Gerenciar Contas</button>
        <button onclick="exportAllAccounts()">📤 Exportar Todas as Contas</button>
        <button onclick="showAccountStats()">📊 Ver Estatísticas</button>
        <div id="accountStats" class="test-result">Nenhuma estatística carregada ainda.</div>
    </div>
    
    <div class="test-section">
        <h2>🔗 Navegação</h2>
        <button onclick="goToDashboard()">📊 Ir para Dashboard</button>
        <button onclick="goToLogin()">🔑 Ir para Login</button>
        <button onclick="goToHome()">🏠 Ir para Home</button>
    </div>

    <script src="js/global.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        function checkStatus() {
            const sessionData = localStorage.getItem('chicasEventos_session');
            const statusDiv = document.getElementById('currentStatus');
            
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    const now = new Date().getTime();
                    const sessionTimeout = 24 * 60 * 60 * 1000;
                    
                    if (now - session.timestamp < sessionTimeout) {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = `✅ Usuário logado: ${session.user.nome} (Sessão válida)`;
                    } else {
                        statusDiv.className = 'status warning';
                        statusDiv.textContent = '⚠️ Sessão expirada';
                    }
                } catch (error) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '❌ Erro na sessão: ' + error.message;
                }
            } else {
                statusDiv.className = 'status warning';
                statusDiv.textContent = '⚠️ Nenhuma sessão encontrada';
            }
        }
        
        function testLogin(userType = 'joao') {
            const testUsers = {
                joao: {
                    id: 1,
                    nome: 'João Silva',
                    email: 'joao@teste.com',
                    telefone: '(11) 99999-9999',
                    tipo: 'cliente'
                },
                maria: {
                    id: 2,
                    nome: 'Maria Santos',
                    email: 'maria@teste.com',
                    telefone: '(11) 88888-8888',
                    tipo: 'admin'
                },
                ana: {
                    id: 3,
                    nome: 'Ana Costa',
                    email: 'ana@teste.com',
                    telefone: '(11) 77777-7777',
                    tipo: 'cliente'
                }
            };
            
            const testUser = testUsers[userType];
            
            const sessionData = {
                user: testUser,
                timestamp: new Date().getTime(),
                lembrar: false
            };
            
            localStorage.setItem('chicasEventos_session', JSON.stringify(sessionData));
            
            document.getElementById('loginResult').textContent = 
                `✅ Login simulado realizado!\n` +
                `Usuário: ${testUser.nome}\n` +
                `Email: ${testUser.email}\n` +
                `Tipo: ${testUser.tipo}\n` +
                `Telefone: ${testUser.telefone}\n` +
                `Timestamp: ${new Date(sessionData.timestamp).toLocaleString()}`;
            
            checkStatus();
        }
        
        function testLogout() {
            localStorage.removeItem('chicasEventos_session');
            
            document.getElementById('loginResult').textContent = 
                `✅ Logout realizado!\n` +
                `Sessão removida do localStorage\n` +
                `Timestamp: ${new Date().toLocaleString()}`;
            
            checkStatus();
        }
        
        function testPersistence() {
            const sessionData = localStorage.getItem('chicasEventos_session');
            let result = 'Teste de Persistência:\n\n';
            
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    const now = new Date().getTime();
                    const sessionTimeout = 24 * 60 * 60 * 1000;
                    const timeLeft = sessionTimeout - (now - session.timestamp);
                    
                    result += `✅ Sessão encontrada\n`;
                    result += `Usuário: ${session.user.nome}\n`;
                    result += `Tempo restante: ${Math.round(timeLeft / (1000 * 60))} minutos\n`;
                    result += `Válida: ${timeLeft > 0 ? 'Sim' : 'Não'}\n`;
                } catch (error) {
                    result += `❌ Erro ao analisar sessão: ${error.message}\n`;
                }
            } else {
                result += `⚠️ Nenhuma sessão encontrada\n`;
            }
            
            result += `\nTeste de recarregamento da página...\n`;
            result += `Se você recarregar esta página, a sessão deve persistir.\n`;
            
            document.getElementById('persistenceResult').textContent = result;
        }
        
        function testMultipleUsers() {
            let result = 'Teste de Múltiplos Usuários:\n\n';
            
            const users = ['joao', 'maria', 'ana'];
            let testResults = [];
            
            users.forEach((userType, index) => {
                // Simular login
                testLogin(userType);
                
                // Verificar se a sessão foi salva corretamente
                const sessionData = localStorage.getItem('chicasEventos_session');
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    testResults.push(`✅ ${session.user.nome} - Login OK`);
                } else {
                    testResults.push(`❌ ${userType} - Falha no login`);
                }
                
                // Pequena pausa entre testes
                setTimeout(() => {}, 100);
            });
            
            result += testResults.join('\n');
            result += `\n\n✅ Sistema suporta múltiplos usuários!\n`;
            result += `Cada usuário mantém sua sessão independentemente.`;
            
            document.getElementById('multipleUsersResult').textContent = result;
        }
        
        function goToDashboard() {
            window.location.href = 'pages/dashboard/dashboard.html';
        }
        
        function goToLogin() {
            window.location.href = 'pages/login/login.html';
        }
        
        function goToHome() {
            window.location.href = 'index.html';
        }
        
        function goToAccountManager() {
            window.location.href = 'gerenciar-contas.html';
        }
        
        function exportAllAccounts() {
            if (window.authSystem) {
                try {
                    const exportData = window.authSystem.exportAccounts();
                    document.getElementById('accountStats').textContent = 
                        `✅ ${exportData.totalUsers} contas exportadas com sucesso!\n` +
                        `Arquivo: chicas_eventos_contas_${new Date().toISOString().split('T')[0]}.json\n` +
                        `Data da exportação: ${new Date(exportData.exportDate).toLocaleString('pt-BR')}`;
                } catch (error) {
                    document.getElementById('accountStats').textContent = 
                        `❌ Erro ao exportar: ${error.message}`;
                }
            } else {
                document.getElementById('accountStats').textContent = 
                    '❌ Sistema de autenticação não disponível';
            }
        }
        
        function showAccountStats() {
            if (window.authSystem) {
                try {
                    const report = window.authSystem.getAccountsReport();
                    document.getElementById('accountStats').textContent = 
                        `📊 Relatório de Contas:\n\n` +
                        `Total de contas: ${report.totalAccounts}\n` +
                        `Clientes: ${report.accountsByType.cliente.length}\n` +
                        `Administradores: ${report.accountsByType.admin.length}\n` +
                        `Última atualização: ${report.stats ? new Date(report.stats.lastUpdate).toLocaleString('pt-BR') : 'N/A'}\n\n` +
                        `Contas recentes:\n` +
                        report.recentAccounts.map(account => 
                            `• ${account.nome} (${account.email}) - ${new Date(account.dataCadastro).toLocaleDateString('pt-BR')}`
                        ).join('\n');
                } catch (error) {
                    document.getElementById('accountStats').textContent = 
                        `❌ Erro ao obter estatísticas: ${error.message}`;
                }
            } else {
                document.getElementById('accountStats').textContent = 
                    '❌ Sistema de autenticação não disponível';
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            
            // Verificar status a cada 2 segundos
            setInterval(checkStatus, 2000);
        });
        
        // Monitorar mudanças no localStorage
        window.addEventListener('storage', function(e) {
            if (e.key === 'chicasEventos_session') {
                console.log('Sessão alterada:', e.newValue);
                checkStatus();
            }
        });
    </script>
</body>
</html>
